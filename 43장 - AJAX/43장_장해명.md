# 43장. AJAX

> 1. AJAX 란
> 2. JSON
> 3. XMLHttpRequest
> 4. AJAX 라이브러리

### 1. AJAX 란 ?

> 브라우저의 XMLHttpRequest 객체를 사용해 비동기적으로 데이터를 교환하고, 이후 페이지 일부만을 빠르게 업데이트 할 수 있는 방식 (최근 : XMLHttpRequest → `fetch API` → AJAX 라이브러리 활용)

![400](https://i.imgur.com/ytOOHhF.png)

![400](https://i.imgur.com/LmICM8t.png)

**장점**

1. 갱신이 필요한 일부를 빠르게 로드할 수 있으므로 불필요한 데이터 통신이 발생하지 않고, 화면이 부드럽게 표시된다.
2. 브라우저와 서버 사이 비동기적으로 데이터가 통신되므로 블로킹이 발생하지 않는다.

**동작 과정**

1. 요청 이벤트 발생 → 이벤트 핸들러에 의해 자바스크립트 호출
2. XMLHTTPRequest 객체를 이용해 서버에 요청을 보냄
3. 서버는 JSON 형태 데이터를 웹 브라우저에 전달
4. 웹 브라우저는 전달 받은 데이터를 기반, 필요한 부분만 다시 업데이트 후 렌더링

### 2. JSON

> 클라이언트와 서버 간 데이터 교환을 위한 규칙 (데이터 포맷)

```js
{
  "name": "Lee",
  "gender": "male",
  "age": 20,
  "alive": true
}
```

- 자바스크립트의 객체 리터럴과 비슷하지만, 순수한 텍스트로 구성되어 있는 데이터 구조
- `""` 를 사용하고, 자바스크립트 뿐만 아니라 대부분 프로그래밍 언어에서 사용 가능함

### 2-1. JSON.stringify

> _객체를 JSON 형식의 문자열로 변환하는 메서드_

```js
const obj = { name: "James", age: 24 };
const json = JSON.stringify(obj);
console.log(json); // {"name":"James","age":24}
```

- `JSON.stringify( )` : 브라우저가 서버에게 요청을 보낼 때, 객체, 배열을 직접 보낼 수 없고 JSON 형식의 문자열로 변환할 때 사용하는 메서드 (직렬화)

### 2-2. JSON.parse

> _JSON 문자열을 자바스크립트 객체로 변환하는 메서드_ > _JSON.stringify 와 반대되는 개념_

```js
const jsonString = '{"name" : "James", "age" : 24}';
const obj = JSON.parse(jsonString);
console.log(obj); // { name: 'James', age: 24 }
```

- `JSON.parse( )` : 서버에서 받은 데이터는 문자열 형태의 JSON 이므로, 이를 자바스크립트에서 다루기 위해 변환할 때 사용하는 메서드

### 3. XMLHttpRequest

> _서버와 비동기적으로 데이터를 주고받을 수 있도록 브라우저에서 제공하는 자바스크립트 API_

- 브라우저는 XMLHttpRequest 객체를 이용해 Ajax 요청을 서버에 전송한다.
- 이후 서버가 응답을 반환하면, XMLHttpRequest 객체가 결과를 처리한다.

### 3-1. AJAX 요청

```js
const xhr = new XMLHttpRequest(); // 객체 생성
xhr.open("GET", "/users"); // HTTP 요청 초기화
xhr.send();
```

1. XMLHttpRequest 객체를 생성한다
2. `.open( )` 로 서버에 요청을 보낼 준비를 한다 (어떤 요청을, 어떤 경로에 보낼지 준비)

```js
// method : HTTP 메서드
// url : 요청을 보낼 URL
// async : 비동기 조작 여부, 기본값은 true 지만 선택 가능
XMLHttpRequest.open(method, url[, async])
```

3. setRequestHeader( ) 로 필요에 따라 HTTP Request Header 값을 설정한다.

```js
xhr.setRequestHeader('Content-type', 'application/json');
xhr.setRequestHeader('Accept' 'application/json');
```

- `Content-type` : 요청 몸체에 담아 전송할 데이터의 MIME-type 정보
- `Accept` : 서버가 응답할 데이터의 MIME-type 정보 지정
  - 서버에게 ‘이런 형식의 ~ 데이터를 받고 싶다’ 고 요청하는 것
  - 설정하지 않을 경우 (`Accept: */*` ) : 어떤 형식이든 다 받을 수 있다는 의미

> _MIME-type : 파일, 데이터 형식을 나타내는 문자열 (쉽게 말해, 데이터 형식)_

![](https://i.imgur.com/cNLnQqH.png)

4. `.send( )` 로 서버에 Request 를 보낸다.

| 요청 방식 | 데이터를 서버에 전달하는 방법                |                                          |
| --------- | -------------------------------------------- | ---------------------------------------- |
| GET       | URL 의 쿼리 문자열을 사용함                  | `.open( )` 에서 url 에 삽입              |
| POST      | 페이로드를 요청의 본문 (body) 에 담아 전송함 | `.send( )` 에서 `JSON.stringify( )` 사용 |

- **특정 유저의 정보를 서버로부터 가져와야 하는 경우**
  > 🙆🏻 `GET` 은 URL 이 노출되므로, 비밀번호나 개인 정보 같이 민감한 데이터는 `POST` 방식을 사용한다\*

```js
const xhr = new XMLHttpRequest();
xhr.open("GET", "/users?name=James&age=24"); // URL 의 쿼리 문자열에 포함
xhr.send();
```

> 🚀 `GET` 으로 HTTP 요청을 보낼 경우, send( ) 의 인수는 무시되고 request body 는 `null` 로 설정된다.

### 3-2. 응답 처리

> `readyState` 프로퍼티 (HTTP 요청의 현재 상태) 값이 변경된 경우 발생하는 `readystatechange` 이벤트를 캐치해서, HTTP 응답을 처리할 수 있다 = `XMLHttpRequest.readyState` 프로퍼티가 변경 (이벤트 발생) 될 떄마다 `onreadystatechange` 이벤트 핸들러가 호출된다.

```js
const xhr = new XMLHttpRequest();

xhr.onreadystatechange = () => {
  // 서버 응답이 완료되지 않았다면 아무 처리도 하지 않음
  // readyState 는 XMLHttpRequest 의 상태를 반환함
  // readyState: 4 -> DONE (서버 응답 완)
  if (xhr.readyState !== XMLHttpRequest.DONE) return;

  // 정상과 에러 처리를 구분하여 출력
  if (xhr.status === 200) {
    console.log(JSON.parse(xhr.response));
  } else {
    console.err("Error", xhr.status, xhr.statusText);
  }
};
```

> _readystatechange 이벤트는 HTTP 요청 현재 상태를 나타는 readystate 프로퍼티가 변경될 떄마다 발생한다._

1. `onreadystatechange` 의 이벤트 핸들러에서 `readyState` 이 `DONE` 인지 확인한다 (서버 응답)
2. HTTP status code 를 `xhr.status === 200` 로 확인한다

### [추가] AJAX Library

> AJAX 요청을 쉽게 할 수 있도록 만들어진 유틸리티 라이브러리들
> → jQuery, axios… 와 같이 AJAX 를 이용해 개발을 할 수 있도록 만들어둔 개발 환경

- axios 는 브라우저에서 `XMLHttpRequest` 를 사용해 HTTP 요청을 보낸다.
- axios 를 사용했을 때 코드가 더 직관적인 이유
  - 내부적으로 `XMLHttpRequest` 를 사용해 요청 전송, 응답을 처리하는 복잡한 과정을 숨기고 있기 때문이다.
